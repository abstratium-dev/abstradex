<div class="partner-relationship-container">
  <div class="page-header">
    <h2>Relationships for Partner {{ getPartnerNumberAndName() || 'Loading...' }}</h2>
    <button class="btn-secondary" (click)="goBack()">‚Üê Back</button>
  </div>

  <div class="actions">
    <button class="btn-primary" (click)="toggleAddForm()">
      {{ showAddForm ? 'Cancel' : '+ Add Relationship' }}
    </button>
  </div>

  <!-- Add Relationship Form -->
  <div class="add-form" *ngIf="showAddForm">
    <h3>Add Relationship to Partner</h3>
    
    <div class="form-group">
      <label for="relationshipType">Relationship Type * (this partners relationship to the selected one)</label>
      <select 
        id="relationshipType" 
        [(ngModel)]="selectedRelationshipTypeId"
        required
      >
        <option value="">-- Select a relationship type --</option>
        <option *ngFor="let type of relationshipTypes" [value]="type.id">
          {{ type.typeName }}
        </option>
      </select>
      <small class="form-hint">
        Can't find the type? 
        <button type="button" class="btn-link" (click)="goToRelationshipTypeManagement()">Manage relationship types</button>
      </small>
    </div>

    <div class="form-group">
      <label for="partnerAutocomplete">Search and Select Partner *</label>
      <abs-autocomplete
        id="partnerAutocomplete"
        name="partnerAutocomplete"
        [(ngModel)]="selectedPartnerId"
        [fetchOptions]="fetchPartners"
        [placeholder]="'Search partners (min 3 characters)...'"
        [minSearchLength]="3"
        [required]="true"
        (optionSelected)="onPartnerSelected($event)"
      ></abs-autocomplete>
      <small class="form-hint">
        Can't find the partner? 
        <button type="button" class="btn-link" (click)="goToPartnerManagement()">Create a new partner</button>
      </small>
    </div>

    <div class="form-group">
      <label for="effectiveFrom">Effective From</label>
      <input 
        type="date" 
        id="effectiveFrom" 
        [(ngModel)]="newRelationship.effectiveFrom"
      />
    </div>

    <div class="form-group">
      <label for="effectiveTo">Effective To</label>
      <input 
        type="date" 
        id="effectiveTo" 
        [(ngModel)]="newRelationship.effectiveTo"
      />
    </div>

    <div class="form-group">
      <label for="notes">Notes</label>
      <textarea 
        id="notes" 
        [(ngModel)]="newRelationship.notes" 
        placeholder="Additional notes about this relationship"
        rows="3"
      ></textarea>
    </div>

    <div class="form-actions">
      <button 
        class="btn-primary" 
        (click)="onSubmitAdd()"
        [disabled]="!selectedPartnerId"
      >
        Add Relationship
      </button>
      <button class="btn-secondary" (click)="toggleAddForm()">Cancel</button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading"><p>Loading partner relationships...</p></div>

  <!-- Error State -->
  <div *ngIf="error" class="error-box">
    <p>{{ error }}</p>
    <button class="btn-primary" (click)="loadPartnerRelationships()">Retry</button>
  </div>

  <!-- Partner Relationships List -->
  <div *ngIf="!loading && !error">
    <h3>Partner Relationships ({{ partnerRelationships.length }})</h3>
    
    <div *ngIf="partnerRelationships.length === 0" class="info-message">
      <p>No relationships found for this partner.</p>
      <p>Click "Add Relationship" to create one.</p>
    </div>

    <div class="tile-list">
      <div *ngFor="let relationship of partnerRelationships; let i = index" class="tile" (click)="closeRelationshipContextMenu(i)">
        <div class="tile-header">
          <div class="tile-info">
            @if(getDirection(relationship) === 'outgoing') {
              <div class="relationship-direction">
                {{ partnerService.getPartnerName(partner) }}
              </div>
              <p class="relationship-type" [title]="getRelationshipTypeTooltip(relationship)">
                <a class="type-link" (click)="navigateToRelationshipTypes($event)">{{ getRelationshipTypeName(relationship) }}</a>
              </p>
              <h3 class="partner-name">
                <a class="partner-link" (click)="navigateToPartner($event, relationship)" [title]="'View ' + getRelatedPartnerName(relationship)">
                  {{ getRelatedPartnerName(relationship) }}
                </a>
              </h3>
            } @else {
              <a class="partner-link" (click)="navigateToPartner($event, relationship)" [title]="'View ' + getRelatedPartnerName(relationship)">
                {{ getRelatedPartnerName(relationship) }}
              </a>
              <p class="relationship-type" [title]="getRelationshipTypeTooltip(relationship)">
                <a class="type-link" (click)="navigateToRelationshipTypes($event)">{{ getRelationshipTypeName(relationship) }}</a>
              </p>
              <div class="relationship-direction">
                {{ partnerService.getPartnerName(partner) }}
              </div>
            }
            <div class="relationship-dates" *ngIf="relationship.effectiveFrom || relationship.effectiveTo">
              <span *ngIf="relationship.effectiveFrom">From: {{ formatDate(relationship.effectiveFrom) }}</span>
              <span *ngIf="relationship.effectiveTo"> To: {{ formatDate(relationship.effectiveTo) }}</span>
            </div>
            <p class="relationship-notes" *ngIf="relationship.notes">{{ relationship.notes }}</p>
          </div>
          <div class="tile-actions">
            <div class="context-menu-wrapper">
              <button class="btn-context-menu" 
                      (click)="toggleRelationshipContextMenu($event, i)" 
                      title="More actions">
                ‚ãÆ
              </button>
              <div class="context-menu" *ngIf="activeRelationshipContextMenuIndex === i">
                <button class="context-menu-item context-menu-item-danger" (click)="onDelete(relationship, $event)">
                  <span class="menu-icon">üóëÔ∏è</span>
                  <span>Remove Relationship</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

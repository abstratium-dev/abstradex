<div class="container">
  <div class="page-header">
    <h1>Partners</h1>
    <div class="header-actions">
      <button class="btn-add" (click)="toggleAddForm()" [disabled]="formSubmitting">
        {{ showAddForm ? 'Cancel' : '+ Add Partner' }}
      </button>
    </div>
  </div>

  <!-- Search Section -->
  <div class="filter-section">
    <div class="filter-input-wrapper">
      <input 
        #searchInput
        type="text" 
        class="filter-input"
        [(ngModel)]="searchTerm"
        (input)="onSearch()"
        placeholder="Search partners by number, name, email, or notes... (min 3 characters)"
        [disabled]="loading()"
        autofocus>
      <button 
        *ngIf="searchTerm" 
        class="filter-clear-button"
        (click)="clearSearch()"
        title="Clear search">
        ‚úï
      </button>
    </div>
    <div class="filter-info" *ngIf="searchTerm">
      Showing {{ partners().length }} result(s) for "{{ searchTerm }}"
    </div>
  </div>
  
  <div *ngIf="loading()" class="loading">
    <p>Loading partners...</p>
  </div>

  <div *ngIf="error()" class="error-box">
    <p>{{ error() }}</p>
    <button (click)="onRetry()">Retry</button>
  </div>

  <!-- Add/Edit Partner Form -->
  <div *ngIf="showAddForm" class="form-container">
    <h2>{{ editingPartner ? 'Edit Partner' : 'Create New Partner' }}</h2>

    <form (ngSubmit)="onSubmitAdd()">
      <div *ngIf="formError" class="error-box">
        {{ formError }}
      </div>

      <!-- Partner Type Selection (only for new partners) -->
      <div *ngIf="!partnerType && !editingPartner" class="partner-type-selection">
        <p class="selection-prompt">What type of partner are you creating?</p>
        <div class="type-buttons">
          <button type="button" class="type-button" (click)="selectPartnerType('natural')" [disabled]="formSubmitting">
            <span class="type-icon">üë§</span>
            <span class="type-label">Natural Person</span>
            <span class="type-description">Individual person</span>
          </button>
          <button type="button" class="type-button" (click)="selectPartnerType('legal')" [disabled]="formSubmitting">
            <span class="type-icon">üè¢</span>
            <span class="type-label">Legal Entity</span>
            <span class="type-description">Company or organization</span>
          </button>
        </div>
      </div>

      <!-- Natural Person Form -->
      <div *ngIf="partnerType === 'natural'">
        <div class="form-group">
          <label for="firstName">First Name *</label>
          <input 
            type="text" 
            id="firstName" 
            [(ngModel)]="newNaturalPerson.firstName" 
            name="firstName"
            autocomplete="given-name"
            placeholder="Enter first name"
            required
            [disabled]="formSubmitting">
        </div>

        <div class="form-group">
          <label for="lastName">Last Name *</label>
          <input 
            type="text" 
            id="lastName" 
            [(ngModel)]="newNaturalPerson.lastName" 
            name="lastName"
            autocomplete="family-name"
            placeholder="Enter last name"
            required
            [disabled]="formSubmitting">
        </div>

        <div class="form-group">
          <label for="middleName">Middle Name</label>
          <input 
            type="text" 
            id="middleName" 
            [(ngModel)]="newNaturalPerson.middleName" 
            name="middleName"
            autocomplete="additional-name"
            placeholder="Enter middle name (optional)"
            [disabled]="formSubmitting">
        </div>

        <div class="form-group">
          <label for="title">Title</label>
          <input 
            type="text" 
            id="title" 
            [(ngModel)]="newNaturalPerson.title" 
            name="title"
            autocomplete="honorific-prefix"
            placeholder="e.g., Mr., Mrs., Dr."
            [disabled]="formSubmitting">
        </div>

        <div class="form-group">
          <label for="dateOfBirth">Date of Birth</label>
          <input 
            type="date" 
            id="dateOfBirth" 
            [(ngModel)]="newNaturalPerson.dateOfBirth" 
            name="dateOfBirth"
            autocomplete="bday"
            [disabled]="formSubmitting">
        </div>

        <div class="form-group">
          <label for="taxId">Tax ID</label>
          <input 
            type="text" 
            id="taxId" 
            [(ngModel)]="newNaturalPerson.taxId" 
            name="taxId"
            autocomplete="off"
            placeholder="Enter tax ID (optional)"
            [disabled]="formSubmitting">
        </div>
      </div>

      <!-- Legal Entity Form -->
      <div *ngIf="partnerType === 'legal'">
        <div class="form-group">
          <label for="legalName">Legal Name *</label>
          <input 
            type="text" 
            id="legalName" 
            [(ngModel)]="newLegalEntity.legalName" 
            name="legalName"
            autocomplete="organization"
            placeholder="Enter legal name"
            required
            [disabled]="formSubmitting">
        </div>

        <div class="form-group">
          <label for="tradingName">Trading Name</label>
          <input 
            type="text" 
            id="tradingName" 
            [(ngModel)]="newLegalEntity.tradingName" 
            name="tradingName"
            autocomplete="off"
            placeholder="Enter trading name (optional)"
            [disabled]="formSubmitting">
        </div>

        <div class="form-group">
          <label for="registrationNumber">Registration Number</label>
          <input 
            type="text" 
            id="registrationNumber" 
            [(ngModel)]="newLegalEntity.registrationNumber" 
            name="registrationNumber"
            autocomplete="off"
            placeholder="Enter registration number"
            [disabled]="formSubmitting">
        </div>

        <div class="form-group">
          <label for="legalTaxId">Tax ID</label>
          <input 
            type="text" 
            id="legalTaxId" 
            [(ngModel)]="newLegalEntity.taxId" 
            name="legalTaxId"
            autocomplete="off"
            placeholder="Enter tax ID"
            [disabled]="formSubmitting">
        </div>

        <div class="form-group">
          <label for="legalForm">Legal Form</label>
          <input 
            type="text" 
            id="legalForm" 
            [(ngModel)]="newLegalEntity.legalForm" 
            name="legalForm"
            autocomplete="off"
            placeholder="e.g., LLC, Corporation, Partnership"
            [disabled]="formSubmitting">
        </div>

        <div class="form-group">
          <label for="incorporationDate">Incorporation Date</label>
          <input 
            type="date" 
            id="incorporationDate" 
            [(ngModel)]="newLegalEntity.incorporationDate" 
            name="incorporationDate"
            autocomplete="off"
            [disabled]="formSubmitting">
        </div>

        <div class="form-group">
          <label for="jurisdiction">Jurisdiction</label>
          <input 
            type="text" 
            id="jurisdiction" 
            [(ngModel)]="newLegalEntity.jurisdiction" 
            name="jurisdiction"
            autocomplete="off"
            placeholder="Enter jurisdiction"
            [disabled]="formSubmitting">
        </div>
      </div>

      <!-- Common Fields (shown after type selection) -->
      <div *ngIf="partnerType === 'natural'">
        <div class="form-group">
          <label for="notes">Notes</label>
          <textarea 
            id="notes" 
            [(ngModel)]="newNaturalPerson.notes" 
            name="notes"
            rows="3"
            placeholder="Optional notes about this partner"
            [disabled]="formSubmitting"></textarea>
        </div>
      </div>

      <div *ngIf="partnerType === 'legal'">
        <div class="form-group">
          <label for="notesLegal">Notes</label>
          <textarea 
            id="notesLegal" 
            [(ngModel)]="newLegalEntity.notes" 
            name="notesLegal"
            rows="3"
            placeholder="Optional notes about this partner"
            [disabled]="formSubmitting"></textarea>
        </div>
      </div>

      <div *ngIf="partnerType">

        <div class="form-actions">
          <button type="submit" class="btn-primary" [disabled]="formSubmitting">
            {{ formSubmitting ? (editingPartner ? 'Updating...' : 'Creating...') : (editingPartner ? 'Update Partner' : 'Create Partner') }}
          </button>
          <button type="button" class="btn-secondary" (click)="toggleAddForm()" [disabled]="formSubmitting">
            Cancel
          </button>
        </div>
      </div>
    </form>
  </div>

  <div *ngIf="!loading() && !error() && partners().length === 0" class="info-message">
    <p>No partners found. Click "Add Partner" to create your first partner.</p>
  </div>

  <div *ngIf="!loading() && !error() && partners().length > 0">
    <div class="partner-list">
      <partner-tile
        *ngFor="let partner of partners()"
        [partner]="partner"
        (delete)="deletePartner($event)"
        (edit)="editPartner($event)"
        (viewOverview)="viewOverview($event)"
        (manageAddresses)="manageAddresses($event)"
        (manageContacts)="manageContacts($event)"
        (manageTags)="manageTags($event)"
      ></partner-tile>
    </div>
  </div>
</div>
